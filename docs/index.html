<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Onyx | AI Handwritten Diary</title>
<meta name="theme-color" content="#0a0a0a">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">

<style>
:root {
  --bg-app:#0a0a0a;
  --bg-paper:#161616;
  --line-ruled:rgba(255,255,255,.06);
  --line-margin:rgba(239,83,80,.15);
  --ink:#e0e0e0;
}

html,body{
  margin:0;height:100%;
  background:var(--bg-app);
  font-family:Inter,sans-serif;
  overflow:hidden;
}

#app{display:flex;flex-direction:column;height:100%}

header{
  height:56px;
  padding:0 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size:12px;
  letter-spacing:2px;
  text-transform:uppercase;
  background:rgba(10,10,10,.9);
  border-bottom:1px solid rgba(255,255,255,.05);
  color:#aaa;
}

main{
  flex:1;
  display:flex;
  justify-content:center;
  overflow:auto;
}

#paper{
  position:relative;
  width:100%;
  max-width:800px;
  min-height:100%;
  background:var(--bg-paper);
  box-shadow:0 0 50px rgba(0,0,0,.5);
}

canvas{
  position:absolute;
  top:0;left:0;
}

#input{
  position:absolute;
  inset:0;
  opacity:0;
  font-size:16px;
  resize:none;
  border:none;
  outline:none;
}
</style>
</head>

<body>
<div id="app">
<header>
  <span>Oct 24</span>
  <span style="color:#fff">ONYX</span>
  <span>Journal</span>
</header>

<main>
  <div id="paper">
    <canvas id="static"></canvas>
    <canvas id="active"></canvas>
    <textarea id="input" spellcheck="false"></textarea>
  </div>
</main>
</div>

<script>
/* ===========================
   ONYX ENGINE â€” FINAL FIXED
   =========================== */

const CONFIG={
  margin:{top:80,left:64,right:24,line:44},
  font:'Caveat',
  size:32,
  ink:'#e0e0e0',
  speed:24,
  cursorLerp:.15,
  jitter:{pos:1.2,rot:.05,size:.08}
};

const rand=s=>{const x=Math.sin(s*9999)*1e4;return x-Math.floor(x)};
const jitter=(c,i)=>({
  x:(rand(i)-.5)*CONFIG.jitter.pos*3,
  y:(rand(i+1)-.5)*CONFIG.jitter.pos*3,
  r:(rand(i+2)-.5)*CONFIG.jitter.rot,
  s:1+(rand(i+3)-.5)*CONFIG.jitter.size
});

class Diary{
  constructor(){
    this.paper=document.getElementById('paper');
    this.cS=document.getElementById('static');
    this.cA=document.getElementById('active');
    this.i=document.getElementById('input');

    this.ctxS=this.cS.getContext('2d');
    this.ctxA=this.cA.getContext('2d');

    this.buf=document.createElement('canvas');
    this.ctxB=this.buf.getContext('2d');

    this.text="Hello.\n\nThis is the final Onyx demo.\nSmooth strokes, ink drying, and cursor physics.\n\nType freely.";
    this.layout=[];
    this.drawIndex=0;
    this.timer=0;

    this.cursor={x:CONFIG.margin.left,y:CONFIG.margin.top,vis:true,blink:0};

    this.i.value=this.text;
    this.i.addEventListener('input',e=>this.onInput(e));
    this.paper.addEventListener('click',()=>this.i.focus());

    new ResizeObserver(()=>this.resize()).observe(this.paper);
    this.resize();
    requestAnimationFrame(t=>this.loop(t));
  }

  resize(){
    const r=this.paper.getBoundingClientRect();
    const dpr=window.devicePixelRatio||1;
    this.w=r.width;this.h=Math.max(r.height,innerHeight);

    [this.cS,this.cA,this.buf].forEach(c=>{
      c.width=this.w*dpr;c.height=this.h*dpr;
      c.style.width=this.w+'px';c.style.height=this.h+'px';
      c.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
    });

    this.drawPaper();
    this.drawIndex=0;
    this.layoutText();
    this.redrawAll();
  }

  drawPaper(){
    const c=this.ctxB;
    c.clearRect(0,0,this.w,this.h);

    c.strokeStyle=CONFIG.line||'rgba(255,255,255,.06)';
    for(let y=CONFIG.margin.top;y<this.h;y+=CONFIG.margin.line){
      c.beginPath();c.moveTo(0,y);c.lineTo(this.w,y);c.stroke();
    }

    c.strokeStyle='rgba(239,83,80,.15)';
    c.beginPath();
    c.moveTo(CONFIG.margin.left-24,0);
    c.lineTo(CONFIG.margin.left-24,this.h);
    c.stroke();
  }

  layoutText(){
    const ctx=this.ctxB;
    ctx.font=`${CONFIG.size}px "${CONFIG.font}"`;

    let x=CONFIG.margin.left;
    let y=CONFIG.margin.top+CONFIG.margin.line*.6;
    const max=this.w-CONFIG.margin.left-CONFIG.margin.right;

    this.layout=[];
    let idx=0;

    for(const line of this.text.split('\n')){
      for(const word of line.split(' ')){
        const ww=ctx.measureText(word).width;
        if(x+ww>CONFIG.margin.left+max){x=CONFIG.margin.left;y+=CONFIG.margin.line;}
        for(const ch of word){
          const w=ctx.measureText(ch).width;
          this.layout.push({ch,x,y,w,i:idx++});
          x+=w;
        }
        x+=ctx.measureText(' ').width;
      }
      x=CONFIG.margin.left;y+=CONFIG.margin.line;
    }
  }

  onInput(e){
    this.text=e.target.value;
    this.layoutText();
    this.drawIndex=0;
    this.redrawAll();
  }

  redrawAll(){
    this.drawPaper();
    for(let i=0;i<this.layout.length;i++) this.drawChar(this.layout[i],false);
    this.ctxS.drawImage(this.buf,0,0,this.w,this.h);
    this.snapCursor();
  }

  drawChar(item,wet){
    if(item.ch===' ')return;
    const ctx=this.ctxB;
    const j=jitter(item.ch,item.i);

    ctx.save();
    ctx.font=`${CONFIG.size}px "${CONFIG.font}"`;
    ctx.fillStyle=CONFIG.ink;
    ctx.globalAlpha=wet?.6:1;
    ctx.translate(item.x+item.w/2+j.x,item.y+j.y);
    ctx.rotate(j.r);ctx.scale(j.s,j.s);
    ctx.fillText(item.ch,-item.w/2,0);
    ctx.restore();
  }

  snapCursor(){
    if(!this.layout.length)return;
    const l=this.layout[this.layout.length-1];
    this.cursor.x=l.x+l.w;this.cursor.y=l.y;
  }

  loop(t){
    requestAnimationFrame(tt=>this.loop(tt));
    this.ctxA.clearRect(0,0,this.w,this.h);

    if(this.drawIndex<this.layout.length){
      this.timer+=16;
      if(this.timer>CONFIG.speed){
        const item=this.layout[this.drawIndex];
        this.drawChar(item,true);
        this.ctxS.drawImage(this.buf,0,0,this.w,this.h);
        this.cursor.x=item.x+item.w;
        this.cursor.y=item.y;
        this.drawIndex++;
        this.timer=0;
      }
    }

    const tgt=this.layout[this.drawIndex]||this.layout[this.layout.length-1];
    if(tgt){
      this.cursor.x+=((tgt.x+(tgt.w||0))-this.cursor.x)*CONFIG.cursorLerp;
      this.cursor.y+=(tgt.y-this.cursor.y)*CONFIG.cursorLerp;
    }

    this.drawCursor();
  }

  drawCursor(){
    const c=this.ctxA;
    const {x,y}=this.cursor;
    c.fillStyle=CONFIG.ink;
    c.beginPath();
    c.arc(x,y-2,2.5,0,Math.PI*2);
    c.fill();
    c.globalAlpha=.5;
    c.beginPath();
    c.moveTo(x,y-2);
    c.lineTo(x+4,y-8);
    c.stroke();
    c.globalAlpha=1;
  }
}

document.fonts.ready.then(()=>new Diary());
</script>
</body>
</html>
